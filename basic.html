<html>

<head>

  <meta charset="utf-8" />

  <!-- Optimal rendering on mobile devices. -->
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Sample CSS styles for demo purposes. You can override these styles to match your web page's branding. -->
  <link rel="stylesheet" type="text/css"
    href="https://www.paypalobjects.com/webstatic/en_US/developer/docs/css/cardfields.css" />
  <style>
    #loader {
      border: 12px solid #f3f3f3;
      border-radius: 50%;
      border-top: 12px solid #444444;
      width: 70px;
      height: 70px;
      animation: spin 1s linear infinite;
    }

    .center {
      position: absolute;
      top: 0;
      bottom: 0;
      left: 0;
      right: 0;
      margin: auto;
    }

    @keyframes spin {
      100% {
        transform: rotate(360deg);
      }
    }

    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, 0.8);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 999;
      display: none;
    }
  </style>
  <script>
    // Your web app's Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyDnwfyNGpv6jRxwZUXWwW8BaiU050bEiAM",
      authDomain: "indit-f68fb.firebaseapp.com",
      projectId: "indit-f68fb",
      storageBucket: "indit-f68fb.appspot.com",
      messagingSenderId: "1012183571371",
      appId: "1:1012183571371:web:523d24ec7aeb724ce150ee",
      measurementId: "G-25QTE7VYV4"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);
    const database = firebase.database();

    function storeData(orderId, payloadData) {
      database.ref('orders/' + orderId).set(payloadData)
        .then(() => {
          console.log("Data stored successfully.");
        })
        .catch((error) => {
          console.error("Error storing data: ", error);
        });
    }
  </script>
</head>

<body>

  <!-- JavaScript SDK -->


  <div class="loading-overlay" id="loader-overlay">
    <div id="loader" class="center"></div>
  </div>
  <script>


    function getQueryParam(name, url) {
      if (!url) {
        url = window.location.href;
      }
      name = name.replace(/[\[\]]/g, '\\$&');
      var regex = new RegExp('[?&]' + name + '(=([^&#]*)|&|#|$)');
      var results = regex.exec(url);
      if (!results) return null;
      if (!results[2]) return '';
      return decodeURIComponent(results[2].replace(/\+/g, ' '));
    }
    function showLoader() {
      document.getElementById("loader-overlay").style.display = "block";
    }

    function hideLoader() {
      document.getElementById("loader-overlay").style.display = "none";
    }
    function loadPayPalSDK(clientIdParam, clientIdTokenParam, cb = null) {
      // var clientIdParam = getQueryParam('clientId');
      // var clientIdTokenParam = getQueryParam('clientIdToken');
      // Define your client token
      //  document.getElementById("loader-container").style.display = "block";
      // let loadingDisplay=document.getElementById("loader-container");
      // loadingDisplay?.style?.display = "block";

      const dataToSend = {
        "client-id": clientIdParam
      }
      const queryString = Object.keys(dataToSend)
        .map(key => `${encodeURIComponent(key)}=${encodeURIComponent(dataToSend[key])}`)
        .join('&');
      // Create and configure the script element
      const scriptElement = document.createElement('script');
      var url = `https://www.paypal.com/sdk/js?${queryString}&components=buttons,hosted-fields&currency=USD&intent=capture`
      //console.log(url);
      // alert(url)
      scriptElement.src = url;
      scriptElement.setAttribute('data-client-token', clientIdTokenParam);
      //scriptElement['data-client-token'] = clientIdTokenParam
      // console.log("script element", scriptElement);
      // alert(clientIdTokenParam)
      //alert(scriptElement['data-client-token'])
      //scriptElement["data-client-token"] = clientIdTokenParam;
      // Append the script to the document's head


      document.body.appendChild(scriptElement);

      if (cb)

        scriptElement.addEventListener('load', function () {

          cb();
        });


    }



  </script>
  <!--<script src="https://www.paypal.com/sdk/js?components=buttons,hosted-fields&client-id=ATAy_J7XueHrYKNogCu0p8lPDll1NAQQkN_9BiBI74zv7zbjFPOrtrP8IOZu08kNqYmUv1VvKEKHYGAL&currency=USD&intent=capture&merchant-id=*" data-partner-attribution-id="FLAVORsb-nnukf26142240_MP" data-merchant-id="UDCKRKYFNGRLQ,JXYWTKNYWHTFC" data-client-token="eyJicmFpbnRyZWUiOnsiYXV0aG9yaXphdGlvbkZpbmdlcnByaW50IjoiMGIyMGI0M2UxODIwOTkwNTc2ZmFiYzRkY2IwZDhkNjAwMDE4ZDZiYmE0NjU5ZjgwYzJiYWI5MTI5OTVkNzIwNXxtZXJjaGFudF9pZD1yd3dua3FnMnhnNTZobTJuJnB1YmxpY19rZXk9NjNrdm4zN3Z0MjlxYjRkZiZjcmVhdGVkX2F0PTIwMjMtMDYtMDJUMDg6NTg6MDkuMzE1WiIsInZlcnNpb24iOiIzLXBheXBhbCJ9LCJwYXlwYWwiOnsiaWRUb2tlbiI6bnVsbCwiYWNjZXNzVG9rZW4iOiJBMjFBQUlNZTV5cGlWb2lMNGJtTFNtcER0UVhtSkQ1aUx0TmpZQUhXb0pYcEZpNHZFY3JSdldYTlhVaUNsTEd2blZMMVlYVkJPcVdOQnFIUng2YXU3dW9Gd19vSUxnakx3In19">-->
  </script>

  <script>
    function getQueryParam(name, url) {

      if (!url) {
        url = window.location.href;
      }
      name = name.replace(/[\[\]]/g, '\\$&');
      var regex = new RegExp('[?&]' + name + '(=([^&#]*)|&|#|$)');
      var results = regex.exec(url);
      if (!results) return null;
      if (!results[2]) return '';
      return decodeURIComponent(results[2].replace(/\+/g, ' '));
    }
    var clientIdParam = getQueryParam('clientId');
    var clientIdTokenParam = getQueryParam('clientIdToken');
    // document.write('<p>Name: ' + clientIdParam + '</p>');
    // document.write('<p>cart: ' + clientIdTokenParam + '</p>');
    // var script = document.createElement('script');

    // // Define your variable
    // //var dynamicValue = "your_value_here";

    loadPayPalSDK(clientIdParam, clientIdTokenParam, function () {
      var tokenParam = getQueryParam('token');
      // tokenParam = JSON.parse(atob(tokenParam))
      var productIdParam = getQueryParam('productID');
      var cartIdParam = getQueryParam('cartID')
      //var cartItem = JSON.parse(atob(cartIdParam))
      var quantityParam = getQueryParam('quantity');
      var variantIdParam = getQueryParam('variantId');
      var shippingIdParam = getQueryParam('shippingId');
 try {
        //var cartItem = JSON.parse(atob(cartIdParam));
        console.log('clientIdTokenParam:', clientIdTokenParam);
    } catch (e) {
        console.log('Error decoding or parsing cartIdParam:', e);
    }

      let orderId = null;

      // Displays PayPal buttons
      let fundingSource;

      paypal.Buttons({

        onClick: (data) => {
          fundingSource = data.fundingSource;

        },
        onCancel: function (data) {

          let orderId = Math.floor(Math.random() * 1000000);
          //console.log(data);
          return fetch('https://qaapi.efindit.net/api/v1/order/cancelpayment/' + data.orderID, {
            method: "post",
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${tokenParam}`,
            },
            body: JSON.stringify(data)
          })
            .then((response) => response.json());

        },
        // Sets up the transaction when a payment button is clicked
        createOrder: function (data, actions) {
          showLoader();
          console.log("data.paymentSource", data.paymentSource);
          var payloadData = {
            "productId": !cartItem && productIdParam ? productIdParam : null,
            "quantity": !cartItem && quantityParam > 0 ? quantityParam : null,
            "variantId": variantIdParam ? variantIdParam : null,
            "cartIds": cartItem?.length > 0 ? cartItem : [],
            "shippigAddresId": shippingIdParam ? shippingIdParam : null,
            "fundingSource": data.paymentSource
          };
          storeData(orderId, payloadData);
          console.log(tokenParam);

          return fetch('https://qaapi.efindit.net/api/v1/Order/PlaceOrder', {
            method: "post",
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${tokenParam}`,
            },
            body: JSON.stringify(payloadData)
          })
            .then((response) => {
              if (!response.ok) {
                // Log the error if the response status is not OK
                console.error('API call failed:', response.status, response.statusText);
                return response.json().then((errorData) => {
                  console.error('Error data:', errorData);
                  throw new Error('Failed to create order');
                });
              }
              return response.json();
            })
            .then((order) => order.id)
            .catch((error) => {
              // Log the error if the fetch itself fails
              console.error('Fetch error:', error);
              // Optionally, you can handle UI updates or alerts here
            });
        },


        // Finalize the transaction after payer approval
        onApprove: function (data, actions) {
          return fetch('https://qaapi.efindit.net/api/v1/Order/' + data.orderID + '/CapturePayment', {
            method: "post",
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${tokenParam}`,
            },
          })
            .then((response) => response.json())
            .then((orderData) => {

              // window.postMessage(orderData.success);
              window.ReactNativeWebView.postMessage(orderData.success)


              //element.innerHTML = '<h3>Thank you for your payment!</h3>';
              // When ready to go live, remove the alert and show a success message within this page. For example:
              // var element = document.getElementById('paypal-button-container');
              // element.innerHTML = '<h3>Thank you for your payment!</h3>';
              // Or go to another URL:  actions.redirect('thank_you.html');
            });
        }
      }).render('#paypal-button-container');

      // If this returns false or the card fields aren't visible, see Step #1.
      // if (paypal.HostedFields.isEligible()) {

      //   // Renders card fields
      //   paypal.HostedFields.render({
      //     // Call your server to set up the transaction
      //     createOrder: () => {
      //       var data = {
      //         "productId": null,
      //         "quantity": null,
      //         "variantId": null,
      //         "cartIds": cartItem?.length > 0 ? cartItem : [],
      //         "shippigAddresId": shippingIdParam ? shippingIdParam : null,
      //         "SaveCard": document.querySelector('#save').checked,
      //         "VaultId": null,
      //         "fundingSource": "card"
      //       };
      //       return fetch('https://qaapi.efindit.net/api/v1/Order/PlaceOrder', {
      //         method: "post",
      //         headers: {
      //           'Content-Type': 'application/json',
      //           'Authorization': `Bearer ${tokenParam}`,
      //         },
      //         body: JSON.stringify(data)
      //       })
      //         .then((res) => res.json())
      //         .then((orderData) => {
      //           orderId = orderData.id;
      //           return orderData.id;
      //         });
      //     },

      //     styles: {
      //       '.valid': {
      //         'color': 'green'
      //       },
      //       '.invalid': {
      //         'color': 'red'
      //       }
      //     },

      //     fields: {
      //       number: {
      //         selector: "#card-number",
      //         placeholder: "4111 1111 1111 1111"
      //       },
      //       cvv: {
      //         selector: "#cvv",
      //         placeholder: "123"
      //       },
      //       expirationDate: {
      //         selector: "#expiration-date",
      //         placeholder: "MM/YY"
      //       }
      //     }
      //   }).then(function (cardFields) {
      //     document.querySelector("#card-form").addEventListener('submit', (event) => {
      //       event.preventDefault();

      //       cardFields.submit({
      //         // Cardholder's first and last name
      //         cardholderName: document.getElementById('card-holder-name').value

      //       }).then((payload) => {
      //         fetch('https://qaapi.efindit.net/api/v1/Order/' + orderId + '/CapturePayment', {
      //           method: "post",
      //           headers: {
      //             'Content-Type': 'application/json',
      //             'Authorization': `Bearer ${tokenParam}`,
      //           },
      //         }).then((res) => res.json())
      //           .then((orderData) => {
      //             // Two cases to handle:
      //             //   (1) Other non-recoverable errors -> Show a failure message
      //             //   (2) Successful transaction -> Show confirmation or thank you
      //             // This example reads a v2/checkout/orders capture response, propagated from the server
      //             // You could use a different API or structure for your 'orderData'

      //             // Show a success message or redirect

      //             window.ReactNativeWebView.postMessage(orderData.success)


      //           });


      //       }).catch(function (err) {
      //         alert('Payment could not be captured! ' + JSON.stringify(err))
      //       });
      //     });
      //   });
      // } else {
      //   // Hides card fields if the merchant isn't eligible
      //   document.querySelector("#card-form").style = 'display: none';
      // }
    });
  </script>

  <div align="center" style="padding: 20px"> Click here to continue </div>
  <table border="0" align="center" valign="top" bgcolor="#FFFFFF" style="width: 39%">
    <tr>
      <td colspan="2">
        <div id="paypal-button-container"></div>
      </td>
    </tr>
    <tr>
      <td colspan="2">&nbsp;</td>
    </tr>
  </table>




</body>

</html>
